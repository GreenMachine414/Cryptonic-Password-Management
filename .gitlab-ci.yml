stages:
    - test
    - deploy

test:
    image: python:3.8.12
    stage: test
    script:
        - .gitlab/test_install.sh
        - coverage run --source='.' manage.py test
        - coverage report

    coverage: '/TOTAL.*\s+(\d+%)$/'


staging-a:
    stage: deploy
    image: ruby:latest
    rules:
        - if: $GITLAB_USER_LOGIN == $GITLAB_USER_LOGIN_A && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
    script:
        - .gitlab/dpl_before_script.sh
        - dpl --provider=heroku --app=${HEROKU_APP_STAGING}-a --api-key=$HEROKU_API_KEY_A


staging-b:
    stage: deploy
    image: ruby:latest
    rules:
        - if: $GITLAB_USER_LOGIN == $GITLAB_USER_LOGIN_B && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
    script:
        - .gitlab/dpl_before_script.sh
        - dpl --provider=heroku --app=${HEROKU_APP_STAGING}-b --api-key=$HEROKU_API_KEY_B

staging-c:
    stage: deploy
    image: ruby:latest
    rules:
        - if: $GITLAB_USER_LOGIN == $GITLAB_USER_LOGIN_C && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
    script:
        - .gitlab/dpl_before_script.sh
        - dpl --provider=heroku --app=${HEROKU_APP_STAGING}-c --api-key=$HEROKU_API_KEY_C


staging-d:
    stage: deploy
    image: ruby:latest
    rules:
        - if: $GITLAB_USER_LOGIN == $GITLAB_USER_LOGIN_D && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
    script:
        - .gitlab/dpl_before_script.sh
        - dpl --provider=heroku --app=${HEROKU_APP_STAGING}-d --api-key=$HEROKU_API_KEY_D

production:
    stage: deploy
    image: ruby:latest
    before_script:
        - .gitlab/dpl_before_script.sh
    script:
        - dpl --provider=heroku --app=${HEROKU_APP_STAGING} --api-key=$HEROKU_API_KEY_A
    only:
        - master
